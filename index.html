<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>EMS Bonus Calculator ‚Äî Labtech, Medical, Ambulance, Students</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: linear-gradient(135deg, #0ea5e9 0%, #7c3aed 100%); min-height: 100vh; }
    .card { background: #fff; border-radius: 16px; box-shadow: 0 20px 40px rgba(0,0,0,.08); }
    .tab { cursor: pointer; }
    .tab.active { background: #111827; color: #fff; }
    pre { background: #0b1220; color: #c8e1ff; padding: 16px; border-radius: 12px; }
    .tiny { font-feature-settings: "tnum"; font-variant-numeric: tabular-nums; }
    .hint { color:#64748b; }
    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .grid3 { display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
    .pill { background:#f1f5f9; padding:8px 10px; border-radius:10px; }
  </style>
</head>
<body class="p-4 md:p-8">
  <div class="max-w-7xl mx-auto card p-6 md:p-8">
    <h1 class="text-3xl md:text-4xl font-extrabold text-center mb-2 bg-gradient-to-r from-cyan-500 to-purple-600 bg-clip-text text-transparent">
      EMS Bonus Calculator
    </h1>
    <p class="text-center text-gray-600 mb-6">Labtech ‚Ä¢ Medical Department ‚Ä¢ Ambulance ‚Ä¢ Medical Students ‚Äî with saved settings and outputs</p>

    <!-- Top Settings -->
    <div class="bg-slate-50 rounded-xl p-4 md:p-6 mb-6">
      <div class="grid md:grid-cols-2 gap-3">
        <div>
          <label class="text-sm font-semibold text-gray-700">Role Mentions</label>
          <input id="roles" class="w-full mt-1 px-3 py-2 border-2 border-slate-200 rounded-lg focus:border-purple-500 outline-none" value="<@&914800296679583784> <@&889769208567705630>">
        </div>
        <div>
          <label class="text-sm font-semibold text-gray-700">Your Mention ID</label>
          <input id="author" class="w-full mt-1 px-3 py-2 border-2 border-slate-200 rounded-lg focus:border-purple-500 outline-none" value="<@851784213707358218>">
        </div>
        <div>
          <label class="text-sm font-semibold text-gray-700">Date Title</label>
          <input id="dateTitle" class="w-full mt-1 px-3 py-2 border-2 border-slate-200 rounded-lg focus:border-purple-500 outline-none" value="22nd October Bonuses">
        </div>
        <div>
          <label class="text-sm font-semibold text-gray-700">Header Title</label>
          <input id="headerTitle" class="w-full mt-1 px-3 py-2 border-2 border-slate-200 rounded-lg focus:border-purple-500 outline-none" value="Daily Bonus">
        </div>
      </div>
      <div class="flex gap-3 mt-4">
        <button id="saveAll" class="px-4 py-2 rounded-lg bg-green-600 text-white font-semibold hover:bg-green-700">Save</button>
        <button id="clearAll" class="px-4 py-2 rounded-lg bg-red-600 text-white font-semibold hover:bg-red-700">Clear</button>
        <span id="status" class="ml-2 text-sm font-semibold"></span>
      </div>
    </div>

    <!-- Tabs -->
    <div class="flex flex-wrap gap-2 mb-6">
      <div class="tab active px-3 py-2 rounded-lg bg-slate-200" data-tab="labtech">Labtech</div>
      <div class="tab px-3 py-2 rounded-lg bg-slate-200" data-tab="medical">Medical Dept</div>
      <div class="tab px-3 py-2 rounded-lg bg-slate-200" data-tab="ambulance">Ambulance</div>
      <div class="tab px-3 py-2 rounded-lg bg-slate-200" data-tab="students">Medical Students</div>
      <div class="tab px-3 py-2 rounded-lg bg-slate-200" data-tab="config">Config</div>
    </div>

    <!-- LABTECH -->
    <section id="tab-labtech" class="space-y-4">
      <div class="pill text-sm">
        <:EMS_Star:1319031331673342033> Labtech Department Bonus Structure
        ‚Äî cascading tiers (consumes Tier 1 ‚Üí Tier 2 ‚Üí Tier 3 ‚Üí base). Edit rates in Config.
      </div>
      <div>
        <label class="font-semibold">Raw Labtech Data</label>
        <p class="hint text-sm">Formats: ‚ÄúID - 3 cap 1 deli‚Äù or ‚ÄúID - Captchas Completed: 10 Deliveries Made : 5‚Äù</p>
        <textarea id="rawLabtech" rows="8" class="w-full mt-2 font-mono text-sm px-3 py-2 border-2 border-slate-200 rounded-lg focus:border-purple-500 outline-none"></textarea>
      </div>
      <div class="flex gap-3">
        <button id="genLabtech" class="px-4 py-2 rounded-lg bg-indigo-600 text-white font-semibold hover:bg-indigo-700">Generate Markdown</button>
        <button id="copyLabtech" class="px-4 py-2 rounded-lg bg-emerald-600 text-white font-semibold hover:bg-emerald-700">Copy</button>
      </div>
      <pre id="outLabtech"></pre>
    </section>

    <!-- MEDICAL -->
    <section id="tab-medical" class="space-y-4 hidden">
      <div class="pill text-sm">
        Medical Department ‚Äî Pillbox Hill (PH1/PH2) and Sandy Shores (SH) with Day/Night/Late-Night. Full hour required per entry; hours are integers.
      </div>
      <div>
        <label class="font-semibold">Raw Medical Data</label>
        <p class="hint text-sm">Format examples per line:
          ‚ÄúID - 8H PH2 Night‚Äù, ‚ÄúID - 7H PH2 Day‚Äù, ‚ÄúID - 6H On Calls Day‚Äù, ‚ÄúID - 2H SH Night‚Äù, ‚ÄúID - 3H PH1 Day‚Äù, ‚ÄúID - 1H PH1 Late Night‚Äù.</p>
        <textarea id="rawMedical" rows="10" class="w-full mt-2 font-mono text-sm px-3 py-2 border-2 border-slate-200 rounded-lg focus:border-purple-500 outline-none"></textarea>
      </div>
      <div class="flex gap-3">
        <button id="genMedical" class="px-4 py-2 rounded-lg bg-indigo-600 text-white font-semibold hover:bg-indigo-700">Generate Markdown</button>
        <button id="copyMedical" class="px-4 py-2 rounded-lg bg-emerald-600 text-white font-semibold hover:bg-emerald-700">Copy</button>
      </div>
      <pre id="outMedical"></pre>
    </section>

    <!-- AMBULANCE -->
    <section id="tab-ambulance" class="space-y-4 hidden">
      <div class="pill text-sm">
        Ambulance ‚Äî on-call hours with Day/Night rates. Example: ‚ÄúID - 2H On Calls Day‚Äù.
      </div>
      <div>
        <label class="font-semibold">Raw Ambulance Data</label>
        <textarea id="rawAmbulance" rows="8" class="w-full mt-2 font-mono text-sm px-3 py-2 border-2 border-slate-200 rounded-lg focus:border-purple-500 outline-none"></textarea>
      </div>
      <div class="flex gap-3">
        <button id="genAmbulance" class="px-4 py-2 rounded-lg bg-indigo-600 text-white font-semibold hover:bg-indigo-700">Generate Markdown</button>
        <button id="copyAmbulance" class="px-4 py-2 rounded-lg bg-emerald-600 text-white font-semibold hover:bg-emerald-700">Copy</button>
      </div>
      <pre id="outAmbulance"></pre>
    </section>

    <!-- STUDENTS -->
    <section id="tab-students" class="space-y-4 hidden">
      <div class="pill text-sm">
        Medical Students ‚Äî simplified hourly payouts by location and shift. Example: ‚ÄúID - 2H PH Day + 6H On Calls Day‚Äù.
      </div>
      <div>
        <label class="font-semibold">Raw Students Data</label>
        <textarea id="rawStudents" rows="10" class="w-full mt-2 font-mono text-sm px-3 py-2 border-2 border-slate-200 rounded-lg focus:border-purple-500 outline-none"></textarea>
      </div>
      <div class="flex gap-3">
        <button id="genStudents" class="px-4 py-2 rounded-lg bg-indigo-600 text-white font-semibold hover:bg-indigo-700">Generate Markdown</button>
        <button id="copyStudents" class="px-4 py-2 rounded-lg bg-emerald-600 text-white font-semibold hover:bg-emerald-700">Copy</button>
      </div>
      <pre id="outStudents"></pre>
    </section>

    <!-- CONFIG -->
    <section id="tab-config" class="space-y-6 hidden">
      <div class="pill">Edit all payouts and thresholds. Click Save to persist.</div>

      <!-- Labtech Config -->
      <div>
        <h3 class="font-bold text-lg mb-2">Labtech</h3>
        <div class="grid3">
          <div class="p-3 border rounded-lg">
            <div class="font-semibold mb-2">Tier 1</div>
            <div class="grid2">
              <label>Bonus $ <input id="lab_t1_bonus" type="number" class="w-full border rounded px-2 py-1" value="110000"></label>
              <label>Cap <input id="lab_t1_cap" type="number" class="w-full border rounded px-2 py-1" value="16"></label>
              <label>Deli <input id="lab_t1_del" type="number" class="w-full border rounded px-2 py-1" value="7"></label>
            </div>
          </div>
          <div class="p-3 border rounded-lg">
            <div class="font-semibold mb-2">Tier 2</div>
            <div class="grid2">
              <label>Bonus $ <input id="lab_t2_bonus" type="number" class="w-full border rounded px-2 py-1" value="60000"></label>
              <label>Cap <input id="lab_t2_cap" type="number" class="w-full border rounded px-2 py-1" value="8"></label>
              <label>Deli <input id="lab_t2_del" type="number" class="w-full border rounded px-2 py-1" value="4"></label>
            </div>
          </div>
          <div class="p-3 border rounded-lg">
            <div class="font-semibold mb-2">Tier 3</div>
            <div class="grid2">
              <label>Bonus $ <input id="lab_t3_bonus" type="number" class="w-full border rounded px-2 py-1" value="40000"></label>
              <label>Cap <input id="lab_t3_cap" type="number" class="w-full border rounded px-2 py-1" value="6"></label>
              <label>Deli <input id="lab_t3_del" type="number" class="w-full border rounded px-2 py-1" value="3"></label>
            </div>
          </div>
        </div>
        <div class="grid2 mt-3">
          <label>Base per Captcha $ <input id="lab_base_cap" type="number" class="w-full border rounded px-2 py-1" value="8000"></label>
          <label>Base per Delivery $ <input id="lab_base_del" type="number" class="w-full border rounded px-2 py-1" value="5000"></label>
        </div>
      </div>

      <!-- Medical Config -->
      <div>
        <h3 class="font-bold text-lg mb-2">Medical Department ‚Äî Hourly Payouts</h3>
        <div class="grid md:grid-cols-3 gap-4">
          <div class="p-3 border rounded">
            <div class="font-semibold mb-2">Pillbox Hill (PH1)</div>
            <label>Day 1h $ <input id="med_ph1_day_1h" type="number" class="w-full border rounded px-2 py-1" value="10000"></label>
            <label class="mt-2 block">Day 2h $ <input id="med_ph1_day_2h" type="number" class="w-full border rounded px-2 py-1" value="25000"></label>
            <label class="mt-2 block">Night 1h $ <input id="med_ph1_night_1h" type="number" class="w-full border rounded px-2 py-1" value="15000"></label>
            <label class="mt-2 block">Night 2h $ <input id="med_ph1_night_2h" type="number" class="w-full border rounded px-2 py-1" value="35000"></label>
            <label class="mt-2 block">Late 1h $ <input id="med_ph1_late_1h" type="number" class="w-full border rounded px-2 py-1" value="25000"></label>
            <label class="mt-2 block">Late 2h $ <input id="med_ph1_late_2h" type="number" class="w-full border rounded px-2 py-1" value="55000"></label>
          </div>
          <div class="p-3 border rounded">
            <div class="font-semibold mb-2">Pillbox Hill (PH2)</div>
            <label>Day 1h $ <input id="med_ph2_day_1h" type="number" class="w-full border rounded px-2 py-1" value="10000"></label>
            <label class="mt-2 block">Day 2h $ <input id="med_ph2_day_2h" type="number" class="w-full border rounded px-2 py-1" value="25000"></label>
            <label class="mt-2 block">Night 1h $ <input id="med_ph2_night_1h" type="number" class="w-full border rounded px-2 py-1" value="15000"></label>
            <label class="mt-2 block">Night 2h $ <input id="med_ph2_night_2h" type="number" class="w-full border rounded px-2 py-1" value="35000"></label>
            <label class="mt-2 block">Late 1h $ <input id="med_ph2_late_1h" type="number" class="w-full border rounded px-2 py-1" value="25000"></label>
            <label class="mt-2 block">Late 2h $ <input id="med_ph2_late_2h" type="number" class="w-full border rounded px-2 py-1" value="55000"></label>
          </div>
          <div class="p-3 border rounded">
            <div class="font-semibold mb-2">Sandy Shores (SH)</div>
            <label>Day 1h $ <input id="med_sh_day_1h" type="number" class="w-full border rounded px-2 py-1" value="15000"></label>
            <label class="mt-2 block">Day 2h $ <input id="med_sh_day_2h" type="number" class="w-full border rounded px-2 py-1" value="35000"></label>
            <div class="mt-2 text-sm">Late Night Window: 21:00‚Äì07:00</div>
            <label class="mt-2 block">Late per hour $ <input id="med_sh_late_1h" type="number" class="w-full border rounded px-2 py-1" value="35000"></label>
          </div>
        </div>
      </div>

      <!-- Ambulance Config -->
      <div>
        <h3 class="font-bold text-lg mb-2">Ambulance ‚Äî On Calls</h3>
        <div class="grid2">
          <label>Day per hour $ <input id="amb_day_1h" type="number" class="w-full border rounded px-2 py-1" value="10000"></label>
          <label>Night per hour $ <input id="amb_night_1h" type="number" class="w-full border rounded px-2 py-1" value="20000"></label>
        </div>
      </div>

      <!-- Students Config -->
      <div>
        <h3 class="font-bold text-lg mb-2">Medical Students ‚Äî Hourly</h3>
        <div class="grid md:grid-cols-3 gap-4">
          <div class="p-3 border rounded">
            <div class="font-semibold mb-2">Pillbox (PH)</div>
            <label>Day per hour $ <input id="stu_ph_day_1h" type="number" class="w-full border rounded px-2 py-1" value="10000"></label>
            <label class="mt-2 block">Night per hour $ <input id="stu_ph_night_1h" type="number" class="w-full border rounded px-2 py-1" value="15000"></label>
            <label class="mt-2 block">Late per hour $ <input id="stu_ph_late_1h" type="number" class="w-full border rounded px-2 py-1" value="25000"></label>
          </div>
          <div class="p-3 border rounded">
            <div class="font-semibold mb-2">Sandy (SH)</div>
            <label>Day per hour $ <input id="stu_sh_day_1h" type="number" class="w-full border rounded px-2 py-1" value="15000"></label>
            <label class="mt-2 block">Night per hour $ <input id="stu_sh_night_1h" type="number" class="w-full border rounded px-2 py-1" value="20000"></label>
            <label class="mt-2 block">Late per hour $ <input id="stu_sh_late_1h" type="number" class="w-full border rounded px-2 py-1" value="15000"></label>
          </div>
          <div class="p-3 border rounded">
            <div class="font-semibold mb-2">On Calls</div>
            <label>Day per hour $ <input id="stu_calls_day_1h" type="number" class="w-full border rounded px-2 py-1" value="10000"></label>
            <label class="mt-2 block">Night per hour $ <input id="stu_calls_night_1h" type="number" class="w-full border rounded px-2 py-1" value="10000"></label>
          </div>
        </div>
      </div>

      <div class="pt-2">
        <button id="saveConfig" class="px-4 py-2 rounded-lg bg-blue-600 text-white font-semibold hover:bg-blue-700">Save Config</button>
      </div>
    </section>
  </div>

<script>
/* ---------- Persistence ---------- */
const KEY = 'ems_bonus_settings_v1';
const RAW_KEYS = {
  lab: 'ems_raw_lab_v1',
  med: 'ems_raw_med_v1',
  amb: 'ems_raw_amb_v1',
  stu: 'ems_raw_stu_v1',
};
function saveAll() {
  const cfg = gatherConfig();
  const head = {
    roles: qs('#roles').value,
    author: qs('#author').value,
    dateTitle: qs('#dateTitle').value,
    headerTitle: qs('#headerTitle').value,
  };
  localStorage.setItem(KEY, JSON.stringify({cfg, head}));

  localStorage.setItem(RAW_KEYS.lab, qs('#rawLabtech').value || '');
  localStorage.setItem(RAW_KEYS.med, qs('#rawMedical').value || '');
  localStorage.setItem(RAW_KEYS.amb, qs('#rawAmbulance').value || '');
  localStorage.setItem(RAW_KEYS.stu, qs('#rawStudents').value || '');

  setStatus('‚úÖ Saved', 'text-green-600');
}
function loadAll() {
  try {
    const s = localStorage.getItem(KEY);
    if (s) {
      const {cfg, head} = JSON.parse(s);
      applyConfig(cfg);
      if (head) {
        qs('#roles').value = head.roles || '';
        qs('#author').value = head.author || '';
        qs('#dateTitle').value = head.dateTitle || '';
        qs('#headerTitle').value = head.headerTitle || '';
      }
    }
    qs('#rawLabtech').value = localStorage.getItem(RAW_KEYS.lab) || '';
    qs('#rawMedical').value = localStorage.getItem(RAW_KEYS.med) || '';
    qs('#rawAmbulance').value = localStorage.getItem(RAW_KEYS.amb) || '';
    qs('#rawStudents').value = localStorage.getItem(RAW_KEYS.stu) || '';
  } catch(e){}
}
function clearAll() {
  localStorage.removeItem(KEY);
  for (const k of Object.values(RAW_KEYS)) localStorage.removeItem(k);
  setStatus('üóëÔ∏è Cleared', 'text-red-600');
}

function setStatus(msg, cls) {
  const el = qs('#status');
  el.textContent = msg;
  el.className = 'text-sm font-semibold ' + (cls||'');
  setTimeout(()=>{ el.textContent=''; }, 2000);
}

/* ---------- Helpers ---------- */
function qs(s){ return document.querySelector(s); }
function qsa(s){ return [...document.querySelectorAll(s)]; }
function sumAdd(map, id, caps, dels){ if(!map[id]) map[id]={caps:0,dels:0}; map[id].caps+=caps; map[id].dels+=dels; }
function toMoney(n){ return '$' + (n||0).toLocaleString(); }

/* ---------- Config Gather/Apply ---------- */
function gatherConfig() {
  return {
    lab: {
      t1: {bonus: num('#lab_t1_bonus'), cap: num('#lab_t1_cap'), del: num('#lab_t1_del')},
      t2: {bonus: num('#lab_t2_bonus'), cap: num('#lab_t2_cap'), del: num('#lab_t2_del')},
      t3: {bonus: num('#lab_t3_bonus'), cap: num('#lab_t3_cap'), del: num('#lab_t3_del')},
      baseCap: num('#lab_base_cap'), baseDel: num('#lab_base_del'),
    },
    med: {
      ph1: {
        day: {h1: num('#med_ph1_day_1h'), h2: num('#med_ph1_day_2h')},
        night: {h1: num('#med_ph1_night_1h'), h2: num('#med_ph1_night_2h')},
        late: {h1: num('#med_ph1_late_1h'), h2: num('#med_ph1_late_2h')},
      },
      ph2: {
        day: {h1: num('#med_ph2_day_1h'), h2: num('#med_ph2_day_2h')},
        night: {h1: num('#med_ph2_night_1h'), h2: num('#med_ph2_night_2h')},
        late: {h1: num('#med_ph2_late_1h'), h2: num('#med_ph2_late_2h')},
      },
      sh: {
        day: {h1: num('#med_sh_day_1h'), h2: num('#med_sh_day_2h')},
        late1h: num('#med_sh_late_1h'), // per hour
      }
    },
    amb: {
      day: num('#amb_day_1h'),
      night: num('#amb_night_1h'),
    },
    stu: {
      ph: { day: num('#stu_ph_day_1h'), night: num('#stu_ph_night_1h'), late: num('#stu_ph_late_1h') },
      sh: { day: num('#stu_sh_day_1h'), night: num('#stu_sh_night_1h'), late: num('#stu_sh_late_1h') },
      calls: { day: num('#stu_calls_day_1h'), night: num('#stu_calls_night_1h') },
    }
  };
}
function applyConfig(c) {
  if(!c) return;
  if(c.lab){
    val('#lab_t1_bonus',c.lab.t1.bonus); val('#lab_t1_cap',c.lab.t1.cap); val('#lab_t1_del',c.lab.t1.del);
    val('#lab_t2_bonus',c.lab.t2.bonus); val('#lab_t2_cap',c.lab.t2.cap); val('#lab_t2_del',c.lab.t2.del);
    val('#lab_t3_bonus',c.lab.t3.bonus); val('#lab_t3_cap',c.lab.t3.cap); val('#lab_t3_del',c.lab.t3.del);
    val('#lab_base_cap',c.lab.baseCap); val('#lab_base_del',c.lab.baseDel);
  }
  if(c.med){
    const m=c.med;
    val('#med_ph1_day_1h',m.ph1.day.h1); val('#med_ph1_day_2h',m.ph1.day.h2);
    val('#med_ph1_night_1h',m.ph1.night.h1); val('#med_ph1_night_2h',m.ph1.night.h2);
    val('#med_ph1_late_1h',m.ph1.late.h1); val('#med_ph1_late_2h',m.ph1.late.h2);

    val('#med_ph2_day_1h',m.ph2.day.h1); val('#med_ph2_day_2h',m.ph2.day.h2);
    val('#med_ph2_night_1h',m.ph2.night.h1); val('#med_ph2_night_2h',m.ph2.night.h2);
    val('#med_ph2_late_1h',m.ph2.late.h1); val('#med_ph2_late_2h',m.ph2.late.h2);

    val('#med_sh_day_1h',m.sh.day.h1); val('#med_sh_day_2h',m.sh.day.h2);
    val('#med_sh_late_1h',m.sh.late1h);
  }
  if(c.amb){
    val('#amb_day_1h',c.amb.day); val('#amb_night_1h',c.amb.night);
  }
  if(c.stu){
    val('#stu_ph_day_1h',c.stu.ph.day); val('#stu_ph_night_1h',c.stu.ph.night); val('#stu_ph_late_1h',c.stu.ph.late);
    val('#stu_sh_day_1h',c.stu.sh.day); val('#stu_sh_night_1h',c.stu.sh.night); val('#stu_sh_late_1h',c.stu.sh.late);
    val('#stu_calls_day_1h',c.stu.calls.day); val('#stu_calls_night_1h',c.stu.calls.night);
  }
}
function num(sel){ return parseInt(qs(sel).value || '0', 10); }
function val(sel,v){ if(v!==undefined) qs(sel).value = v; }

/* ---------- Tabs ---------- */
qsa('.tab').forEach(t => t.addEventListener('click', () => {
  qsa('.tab').forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  const tgt = t.dataset.tab;
  qsa('section[id^="tab-"]').forEach(s => s.classList.add('hidden'));
  qs('#tab-' + tgt).classList.remove('hidden');
}));

/* ---------- Parsing Utilities ---------- */
function parseIdPair(line) {
  const idx = line.indexOf('-');
  if(idx === -1) return null;
  const id = line.slice(0, idx).trim();
  const rest = line.slice(idx+1).trim();
  if(!/^\d+$/.test(id)) return null;
  return { id, rest };
}
/* Labtech: support ‚Äúx cap y deli‚Äù and ‚ÄúCaptchas Completed: X Deliveries Made : Y‚Äù */
function parseLabtechLine(line) {
  line = line.trim();
  const pair = parseIdPair(line);
  if(!pair) return null;
  const r = pair.rest.toLowerCase();
  let m1 = r.match(/(\d+)\s*cap[^0-9]*(\d+)\s*del/);
  if(m1) return {id: pair.id, caps: parseInt(m1[1]), dels: parseInt(m1[2])};
  let m2 = r.match(/captchas\s*completed\s*:\s*(\d+)[^\d]+deliveries\s*made\s*:?\s*(\d+)/);
  if(m2) return {id: pair.id, caps: parseInt(m2[1]), dels: parseInt(m2[2])};
  return null;
}

/* Medical: lines like ‚ÄúID - 8H PH2 Night‚Äù, ‚ÄúID - 6H On Calls Day‚Äù */
function parseMedicalLine(line) {
  const pair = parseIdPair(line.trim());
  if(!pair) return null;
  const r = pair.rest.replace(/\s+/g,' ').trim();
  // Matches: "8H PH2 Night" | "7H PH2 Day" | "2H SH Night" | "1H On Calls Day" | "3H PH1 Late Night"
  const m = r.match(/(\d+)\s*h\s+([a-z0-9 ]+?)\s+(day|night|late\s*night)/i);
  if(!m) return null;
  let hours = parseInt(m[1]);
  let place = m[2].trim().toUpperCase();  // PH1, PH2, SH, ON CALLS
  let shift = m[3].toLowerCase().replace(/\s+/g,' '); // day, night, late night
  return { id: pair.id, hours, place, shift };
}

/* Ambulance: ‚ÄúID - 2H On Calls Day‚Äù */
function parseAmbulanceLine(line) {
  const o = parseMedicalLine(line);
  if(!o) return null;
  if(o.place !== 'ON CALLS') return null;
  return o;
}

/* Students: allow combined tokens like ‚Äú2H On Calls Day + 1H PH Day‚Äù (split per '+') */
function splitStudentChunks(rest) {
  return rest.split('+').map(s => s.trim()).filter(Boolean);
}
function parseStudentChunk(id, chunk) {
  // Examples: "2H On Calls Day", "1H PH Day", "7H PH Day", "2H On Calls Night", "1H SH Day"
  const m = chunk.match(/(\d+)\s*h\s+([a-z0-9 ]+?)\s+(day|night|late\s*night)/i);
  if(!m) return null;
  let hours = parseInt(m[1]);
  let place = m[2].trim().toUpperCase(); // PH, SH, ON CALLS
  let shift = m[3].toLowerCase().replace(/\s+/g,' ');
  return { id, hours, place, shift };
}
function parseStudentsLine(line) {
  const pair = parseIdPair(line.trim());
  if(!pair) return null;
  const chunks = splitStudentChunks(pair.rest);
  const items = [];
  for (const c of chunks) {
    const o = parseStudentChunk(pair.id, c);
    if(o) items.push(o);
  }
  return items.length ? items : null;
}

/* ---------- Labtech Logic (Cascading) ---------- */
function labtechCascade(totalCaps, totalDels, cfg) {
  let rc = totalCaps, rd = totalDels, parts = [], total = 0;
  // Tier1
  while (rc >= cfg.t1.cap && rd >= cfg.t1.del) {
    total += cfg.t1.bonus; parts.push(`ü•á **Tier 1 Bonus ‚Äî ${toMoney(cfg.t1.bonus)}** ü•á`);
    rc -= cfg.t1.cap; rd -= cfg.t1.del;
  }
  // Tier2
  while (rc >= cfg.t2.cap && rd >= cfg.t2.del) {
    total += cfg.t2.bonus; parts.push(`ü•à **Tier 2 Bonus ‚Äî ${toMoney(cfg.t2.bonus)}** ü•à`);
    rc -= cfg.t2.cap; rd -= cfg.t2.del;
  }
  // Tier3
  while (rc >= cfg.t3.cap && rd >= cfg.t3.del) {
    total += cfg.t3.bonus; parts.push(`ü•â **Tier 3 Bonus ‚Äî ${toMoney(cfg.t3.bonus)}** ü•â`);
    rc -= cfg.t3.cap; rd -= cfg.t3.del;
  }
  if (rc > 0) { total += rc*cfg.baseCap; parts.push(`(${rc} Captchas √ó ${toMoney(cfg.baseCap)} = ${toMoney(rc*cfg.baseCap)})`); }
  if (rd > 0) { total += rd*cfg.baseDel; parts.push(`(${rd} Deliveries √ó ${toMoney(cfg.baseDel)} = ${toMoney(rd*cfg.baseDel)})`); }
  return { parts, total };
}

/* ---------- Medical Logic ---------- */
/* Rules (editable in Config):
  - PH1/PH2 Day: 1h => X; 2h continuous => Y
  - PH1/PH2 Night: 1h => X; 2h continuous => Y
  - PH1/PH2 Late Night: 1h => X; 2h continuous => Y
  - SH Day: 1h => X; 2h => Y
  - SH Late Night: per-hour => Z
  We‚Äôll aggregate by (place, shift) and break into 2h chunks + leftover 1h (if any).
*/
function medicalCalc(items, cfg) {
  // group by user
  const byUser = {};
  for (const it of items) {
    if(!byUser[it.id]) byUser[it.id] = [];
    byUser[it.id].push(it);
  }
  const lines = [];
  let grand = 0;

  for (const id of Object.keys(byUser)) {
    // consolidate counts by place+shift
    const group = {};
    for (const e of byUser[id]) {
      const key = e.place + '|' + e.shift;
      group[key] = (group[key] || 0) + e.hours;
    }
    // compute payouts
    let total = 0;
    const segments = [];
    for (const [key, hours] of Object.entries(group)) {
      const [place, shift] = key.split('|'); // PH1/PH2/SH/ON CALLS
      const h = hours;
      if (place === 'SH' && shift === 'late night') {
        const per = cfg.med.sh.late1h;
        total += h * per;
        segments.push(`${h}H SH Late Night √ó ${toMoney(per)} = ${toMoney(h*per)}`);
      } else if (place === 'PH1' || place === 'PH2' || place === 'SH') {
        const p = place === 'PH1' ? cfg.med.ph1
            : place === 'PH2' ? cfg.med.ph2
            : cfg.med.sh;

        const tier = (shift === 'day') ? p.day
                    : (shift === 'night') ? p.night || p.day
                    : (shift === 'late night') ? p.late || p.day
                    : p.day;

        // For SH, night not configured as special, treat like day unless late-night
        // Break into 2h chunks + leftover 1h
        let left = h;
        const isLate = (place !== 'SH') && (shift === 'late night');
        const twoBonus = (isLate ? p.late.h2 : tier.h2) || 0;
        const oneBonus = (isLate ? p.late.h1 : tier.h1) || 0;

        while (left >= 2 && twoBonus > 0) {
          total += twoBonus;
          segments.push(`2H ${place} ${title(shift)} = ${toMoney(twoBonus)}`);
          left -= 2;
        }
        if (left === 1 && oneBonus > 0) {
          total += oneBonus;
          segments.push(`1H ${place} ${title(shift)} = ${toMoney(oneBonus)}`);
          left -= 1;
        }
        if (left > 0) {
          // any leftover not covered by 1h/2h slots -> ignore (must be full hours)
          segments.push(`${left}H ${place} ${title(shift)} (no payout rule)`);
        }
      } else if (place === 'ON CALLS') {
        // handled in Ambulance module, skip here
      } else {
        segments.push(`${h}H ${place} ${title(shift)} (unknown)`);
      }
    }

    grand += total;
    const segTxt = segments.join(' + ');
    lines.push({id, desc: segTxt, total});
  }
  return {lines, grand};
}

/* ---------- Ambulance Logic ---------- */
function ambulanceCalc(items, cfg) {
  const byUser = {};
  for (const it of items) {
    if(!byUser[it.id]) byUser[it.id]=[];
    byUser[it.id].push(it);
  }
  const lines=[]; let grand=0;
  for (const id of Object.keys(byUser)) {
    let total=0;
    const seg=[];
    for (const it of byUser[id]) {
      const rate = (it.shift==='night') ? cfg.amb.night : cfg.amb.day;
      const val = it.hours * rate;
      total += val;
      seg.push(`${it.hours}H On Calls ${title(it.shift)} = ${toMoney(val)}`);
    }
    grand += total;
    lines.push({id, desc: seg.join(' + '), total});
  }
  return {lines, grand};
}

/* ---------- Students Logic ---------- */
function studentsCalc(allItems, cfg) {
  const byUser = {};
  for (const items of allItems) {
    if (items) {
      for (const it of items) {
        if(!byUser[it.id]) byUser[it.id]=[];
        byUser[it.id].push(it);
      }
    }
  }
  const lines=[]; let grand=0;
  for (const id of Object.keys(byUser)) {
    let total=0; const seg=[];
    for (const it of byUser[id]) {
      let per=0;
      if (it.place==='PH') per = it.shift==='night' ? cfg.stu.ph.night : it.shift==='late night' ? cfg.stu.ph.late : cfg.stu.ph.day;
      else if (it.place==='SH') per = it.shift==='night' ? cfg.stu.sh.night : it.shift==='late night' ? cfg.stu.sh.late : cfg.stu.sh.day;
      else if (it.place==='ON CALLS') per = it.shift==='night' ? cfg.stu.calls.night : cfg.stu.calls.day;
      const val = it.hours * per;
      total += val;
      seg.push(`${it.hours}H ${it.place} ${title(it.shift)} = ${toMoney(val)}`);
    }
    grand += total;
    lines.push({id, desc: seg.join(' + '), total});
  }
  return {lines, grand};
}

/* ---------- Generators ---------- */
function generateHeader() {
  const roles = qs('#roles').value || '';
  const dateTitle = qs('#dateTitle').value || 'Bonuses';
  const headerTitle = qs('#headerTitle').value || 'Daily Bonus';
  return [`# üí∏ ${headerTitle} For ${roles} üí∏`, `# üìÜ ${dateTitle}`, '', '==================================================================', ''];
}
function generateFooter(grand) {
  const author = qs('#author').value || '';
  return ['==================================================================  ', `üí∏ **Final Total: ${toMoney(grand)}** üí∏ ${author}  `, 'üì© **Bonus missing?** DM me with logs or bodycam proof'];
}
function title(s){ return s.split(' ').map(x=>x[0].toUpperCase()+x.slice(1)).join(' '); }

/* Labtech generate */
qs('#genLabtech').addEventListener('click', () => {
  const cfg = gatherConfig();
  const lines = (qs('#rawLabtech').value || '').split('\n');
  const sum = {};
  const order = [];
  for (const ln of lines) {
    const p = parseLabtechLine(ln);
    if(!p) continue;
    if(!sum[p.id]){ sum[p.id]={caps:0,dels:0}; order.push(p.id); }
    sum[p.id].caps += p.caps; sum[p.id].dels += p.dels;
  }
  let out = [...generateHeader()];
  let grand=0;
  for (const id of order) {
    const tot = labtechCascade(sum[id].caps, sum[id].dels, cfg.lab);
    grand += tot.total;
    out.push(`<@${id}> ‚Äî (${sum[id].caps} Captchas + ${sum[id].dels} Deliveries)  `);
    if (tot.parts.some(p=>p.includes('Tier'))) {
      tot.parts.forEach(p => out.push(p + '  '));
      out.push(`**= ${toMoney(tot.total)}**`);
    } else {
      const capB = sum[id].caps * cfg.lab.baseCap;
      const delB = sum[id].dels * cfg.lab.baseDel;
      out.push(`**${toMoney(capB)} + ${toMoney(delB)} = ${toMoney(capB+delB)}**`);
    }
    out.push('');
  }
  out.push(...generateFooter(grand));
  qs('#outLabtech').textContent = out.join('\n');
  setStatus('‚úÖ Labtech generated', 'text-green-600');
});

/* Medical generate */
qs('#genMedical').addEventListener('click', () => {
  const cfg = gatherConfig();
  const lines = (qs('#rawMedical').value||'').split('\n');
  const items=[];
  for (const ln of lines) {
    const p = parseMedicalLine(ln);
    if(p) items.push(p);
  }
  const {lines:rows, grand} = medicalCalc(items, cfg);
  let out = [...generateHeader()];
  for (const r of rows) {
    out.push(`<@${r.id}>  - ${toMoney(r.total)} (${r.desc})`);
  }
  out.push(...generateFooter(grand));
  qs('#outMedical').textContent = out.join('\n');
  setStatus('‚úÖ Medical generated', 'text-green-600');
});

/* Ambulance generate */
qs('#genAmbulance').addEventListener('click', () => {
  const cfg = gatherConfig();
  const lines = (qs('#rawAmbulance').value||'').split('\n');
  const items=[];
  for (const ln of lines) {
    const p = parseAmbulanceLine(ln);
    if(p) items.push(p);
  }
  const {lines:rows, grand} = ambulanceCalc(items, cfg);
  let out = [`# <:EMS_Star:1319031331673342033>  Daily Bonuses  <:EMS_Star:1319031331673342033>`, '', '==================================================================', ''];
  for (const r of rows) {
    out.push(`<@${r.id}> - ${toMoney(r.total)} (${r.desc})`);
  }
  out.push(...generateFooter(grand));
  qs('#outAmbulance').textContent = out.join('\n');
  setStatus('‚úÖ Ambulance generated', 'text-green-600');
});

/* Students generate */
qs('#genStudents').addEventListener('click', () => {
  const cfg = gatherConfig();
  const lines = (qs('#rawStudents').value||'').split('\n');
  const packages = [];
  for (const ln of lines) {
    const items = parseStudentsLine(ln);
    if(items) packages.push(items);
  }
  const {lines:rows, grand} = studentsCalc(packages, cfg);
  let out = [`# üí∏  Daily Bonus For <@&816985266115444756> üí∏`, '', '==================================================================', ''];
  for (const r of rows) {
    out.push(`<@${r.id}> ‚Äî [${r.desc}] ‚Äî **${toMoney(r.total)}**`);
  }
  out.push(...generateFooter(grand));
  qs('#outStudents').textContent = out.join('\n');
  setStatus('‚úÖ Students generated', 'text-green-600');
});

/* Copy buttons */
qs('#copyLabtech').addEventListener('click', ()=>copy('#outLabtech'));
qs('#copyMedical').addEventListener('click', ()=>copy('#outMedical'));
qs('#copyAmbulance').addEventListener('click', ()=>copy('#outAmbulance'));
qs('#copyStudents').addEventListener('click', ()=>copy('#outStudents'));

function copy(sel){
  const txt = qs(sel).textContent || '';
  if(!txt) { setStatus('‚ö†Ô∏è Nothing to copy', 'text-yellow-600'); return; }
  navigator.clipboard.writeText(txt).then(()=>{
    setStatus('‚úÖ Copied', 'text-green-600');
  });
}

/* Config Save */
qs('#saveConfig').addEventListener('click', saveAll);
qs('#saveAll').addEventListener('click', saveAll);
qs('#clearAll').addEventListener('click', clearAll);

/* Init */
loadAll();
</script>
</body>
</html>
